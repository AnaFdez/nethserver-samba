#!/usr/bin/perl -w

use esmith::Build::CreateLinks qw(:all);
use File::Path;

templates2events("/etc/samba/smb.conf", qw(
    nethserver-samba-update
    nethserver-samba-save
    ibay-create
    ibay-delete
    ibay-modify
    network-delete
    network-create
));

my ($event, $daemon, $pkg);

event_actions('nethserver-samba-update',
	      'initialize-default-databases' => '00',
	      'nethserver-samba-conf' => '20',
	      'nethserver-samba-aclsetup' => '22',
	      'firewall-adjust' => '30',
	      'runlevel-adjust' => '30',
	      'nethserver-samba-sam-conf' => '95',
	      'nethserver-samba-user-create' => '96',
	      'nethserver-samba-group-create' => '97'
    );


# When updating nethserver-directory, samba LDAP user acl must be set
# again, otherwise we are locked out:
event_actions('nethserver-directory-update',
	      'nethserver-samba-aclsetup' => '30');


# actions for group-create event:
event_actions('group-create', 
	      "nethserver-samba-group-create" => "30"
);

# All of these events require smbd to reload the smb.conf file:
event_actions($_,
	      "nethserver-samba-smbd-adjust" => '95'
) foreach (qw(
    group-create
    group-delete
    group-modify
    ibay-create
    ibay-delete
    ibay-modify
    network-create
    network-delete
    printer-create
    printer-delete
));

event_actions('user-create',
	      "nethserver-samba-user-create" => '20',
	      "nethserver-samba-profile-create" => '25',
	      "nethserver-samba-user-modify" => '30',
);

event_actions('user-delete',
	      'nethserver-samba-smbd-adjust' => '30',
	      'nethserver-samba-profile-delete' => '40',
);

event_actions('user-modify',
	      "nethserver-samba-user-modify" => '30',
);

event_actions('user-lock',
	      "nethserver-samba-user-modify" => '30',
	      "nethserver-samba-smbd-adjust" => '95',
);

event_actions('user-unlock',
	      "nethserver-samba-user-modify" => '30',
	      "nethserver-samba-smbd-adjust" => '95',
);

event_actions("delete_printer_tdb",
	      'printer-delete' => '15',
);

event_actions("nethserver-samba-machine-create",
	      "nethserver-samba-machine-create" => '10',
);

event_actions('password-modify',
	      "nethserver-samba-password-modify" => '40',
);

# event nethserver-samba-save
safe_symlink("restart", "root/etc/e-smith/events/nethserver-samba-save/services2adjust/$_") 
    foreach (qw(smb nmb winbind));

	     
#
# restart daemons on update of required packages :
#
foreach $daemon (qw(nmb smb winbind)) {
    foreach $pkg (qw(base directory samba)) {
	safe_symlink("restart", 
		     "root/etc/e-smith/events/nethserver-$pkg-update/services2adjust/$daemon")
    }	
}


# Refs #1066 - Make sure home/ dir exists in /etc/skel
File::Path::make_path('root/etc/skel/home');
chmod 0750, 'root/etc/skel/home';

#--------------------------------------------------
# actions for interface-update event
#--------------------------------------------------
event_templates('interface-update',
                '/etc/samba/smb.conf');
event_services('interface-update',
               'smb' => 'restart');
event_services('interface-update',
               'nmb' => 'restart');
event_services('interface-update',
               'winbind' => 'restart');

